//Proyecto No.2 
//César CIfuentes 21622
//Código de la Tiva C 
#include <SD.h>
#include <SPI.h>
File archivodemediciones;
float ValorDeBalanza;

//Variables Gblobales 
//Se definen las variables de los bótones 
#define BotonB1 PUSH1
#define BotonB2 PUSH2
#define CS_PIN 12



//Se definen las variables para verificar el estado del bóton y verificar si se incrementa o decrementa el bóton 
volatile bool medir = true; 
volatile bool guardar = true;

//Variable utilizada para recibir la comunicación desde el ESP32 
char Receptor;


//Variables para enviar y recibir el valor del Potenciometro 1 y 2 
float unidad1, decimal1, centesima1;
int unidad2, decimal2, centesima2;


void setup() {

//Configuración de la velocidad de la comunicación 
Serial.begin(115200);
Serial2.begin(115200); 

//Mensaje de confirmación de conexión realizada
Serial.println("Conexión con Computadora  Completa");
Serial.println("Conexión con ESP332 Completa ");

//Configuración de los Bótones como interrupciones 
pinMode(BotonB1, INPUT_PULLUP);
attachInterrupt(BotonB1, ISR_1, FALLING);
pinMode(BotonB2, INPUT_PULLUP);
attachInterrupt(BotonB2, ISR_2, FALLING);


//Configuración de los parametros de la SD
while(!Serial){
  ;
}
SPI.setModule(0);
Serial.print("Initializing SD card...");
pinMode(CS_PIN, OUTPUT);
if (!SD.begin(CS_PIN)) {
    Serial.println("Card initialization failed!");
    while (true);
  }
Serial.println("initialization done.");
}



//Loop principal 
void loop() {

//Código para traer la memoria del sensor 
if (!medir) {
  
  }
//Código para guardar en la memoria SD la toma del sensor 
if (!guardar) {
  archivodemediciones = SD.open("Mediciones de Balanza.csv", FILE_WRITE);
      if (archivodemediciones) {
      Serial.print("Writing in text...");
      archivodemediciones.println(ValorDeBalanza);
      archivodemediciones.close();
      Serial.println("Done");
      }else {
        Serial.println("error opening Mediciones de Balanza.csv!");
      }
}
  }

//Vector de interrupción 
//*****************************************************************************

//Estas interrupciones sirven para generar el aumento o decremento de los ciclos de trabajo al presionar los bótones B1, B2, B4
void ISR_1() {
  medir = false;
}

void ISR_2() {
  guardar = false;
}
